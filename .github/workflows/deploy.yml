name: Deploy to Production

on:
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Navigate to application directory
          cd ${{ secrets.DEPLOY_PATH || '/opt/monolith-app' }}
          
          # Pull latest image
          docker pull ${{ secrets.DOCKER_USERNAME }}/monolith-app:latest
          
          # Stop and remove old container
          docker stop monolith-app || true
          docker rm monolith-app || true
          
          # Run new container
          docker run -d \
            --name monolith-app \
            --restart unless-stopped \
            -p 8080:8080 \
            ${{ secrets.DOCKER_USERNAME }}/monolith-app:latest
          
          # Clean up old images
          docker image prune -af

    - name: Verify deployment
      run: |
        sleep 10
        curl -f http://${{ secrets.DEPLOY_HOST }}:8080/health || exit 1

    - name: Notify deployment success
      if: success()
      run: echo "Deployment successful!"

    - name: Notify deployment failure
      if: failure()
      run: echo "Deployment failed!"
